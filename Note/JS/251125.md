# Javascript - Ajax with Django
# Ajax와 서버
## Ajax(Asynchronous JavaScript and XML)
- 비동기적인 웹 애플리케이션 개발을 위한 기술
- Ajax는 웹 페이지 전체를 새로고침하지 않고, 백그라운드에서 서버와 데이터를 주고받는 비동기 통신 기술
- 구글 지도 앱을 움직여도 끊김이 없고, 좋아요를 눌렀을 때 페이지만 부분적으로 바뀌는 것이 가능
- 웹 페이지를 데스크톱 애플리케이션처럼 동적이고 반응적으로 만들어주는 현대 웹의 핵심 기술
# Ajaxwith follow
## 비동기 팔로우 구현
### 사전 준비
1. M:N 관계 모델링까지 진행된 Django 프로젝트 준비
2. 가상 환경 생성, 활성화 및 패키지 설치
### 비동기 팔로우 구현 - Ajax 적용
- 프로필 페이지에 axios CDN 작성
```html
<!-- accounts/profile.html -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
```
- form 요소 선택을 위해 id 속성 지정 및 선택
- action과 method 속성은 삭제
  - 요청은 axios로 대체할 예정
```html
<!-- accounts/profile.html -->
<form id="follow-form">
  ...
</form>
```
```javascript
// accounts/profile.html
const formTag = document.querySelector('#follow-form')
```
- form 요소에 이벤트 핸들러 할당
- submit 이벤트의 기본 동작 취소하기
```javascript
// accounts/profile.html

formTag.addEventListener('submit', function (event){
  event.preventDefault()
})
```
- axios 요청 코드 작성
  1. 요청 url에 필요한 사용자 pk는 어떻게 작성해야 할까?
  2. CSRF 토큰은 어떻게 보내야 할까?
```javascript
formTag.addEventListener('submit', function (event){
  event.preventDefault()

  axios({
    method: 'POST',  // 팔로우/언팔로우 하면서 데이터를 조작하기 때문에 POST 메서드 
    url: `/accounts/${}/follow/`,  // 버튼을 누르면 해당 url 에 요청 
  })
})
```
- url에 작성할 user pk 가져오기(HTML => JavaScript)
```html
<form id="follow-form" data-user-id="{{ person.pk }}">
  ...
</form>
```
```javascript
formTag.addEventListener('submit', function (event){
  event.preventDefault()

  // 방법1. event.currentTarget: 이벤트 리스너가 부착된 요소(formTag)
  // 가장 명시적이고 안정적인 방법
  // (가장 추천, 누가 봐도 이벤트, 화살표 함수와의 호환 )
  const userId = event.currentTarget.dataset.userId
  // 방법2. 일반 함수이기 때문에 이벤트 리스너가 부착된 요소를 가리킴
  // 화살표 함수를 사용하면 this가 formTag를 가리키지 않기 때문에 주의 
  const userId = this.dataset.userId

  // 방법3. 직관적이고, 화살표함수도 문제가 없지만 
  // 이벤트 핸들러가 formTag에 접근할 수 있는 스코프여야 함 
  const userId = formTag.dataset.userId
  ...
})
```
#### ※ data-* 속성
- 사용자 지정 데이터 속성을 만들어, HTML과 DOM 사이에서 임의의 데이터를 교환하는 방법
- 모든 사용자 지정 데이터는 JavaScript에서 dataset 속성을 통해 접근
- 주의사항
  - 대소문자 여부에 상관업이 xml 문자로 시작 불가
  - 세미콜론 포함 불가
  - 대문자 포함 불가
```html
<div data-my-id="my-data"></div>

<script>
  const myId = event.target.dataset.myId
</script>
```
- 요청 url 작성 마무리
```javascript
formTag.addEventListener('submit', function (event){
  event.preventDefault()

  const userId = event.currentTarget.dataset.userId

  axios({
    method: 'POST',  // 팔로우/언팔로우 하면서 데이터를 조작하기 때문에 POST 메서드 
    url: `/accounts/${userId}/follow/`,  // 버튼을 누르면 해당 url 에 요청 
  })
})
```
- 문서상 input hidden 타입으로 존재하는 csrf token 데이터를 이제는 axios로 전송해야 함
```html
<form id="follow-form" data-user-id="{{ person.pk }}"> 
  {% csrf_token %}
  {% if request.user in person.followers.all %}
    <input type="submit" value='UnFollow'>
  {% else %}
    <input type="submit" value='Follow'>
  {% endif %}
</form>
```
```javascript
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value

formTag.addEventListener('submit', function (event){
  event.preventDefault()
  
  const userId = event.currentTarget.dataset.userId
  
  axios({
    method: 'POST',
    url: `/accounts/${userId}/follow/`,
    headers: {'X-CSRFToken': csrftoken},
  })
})
```
- 팔로우 버튼을 토글하기 위해서는 현재 팔로우 상태인지 언팔로우 상태인지에 대한 상태 확인이 필요
- Django의 view 함수에서, 팔로우 여부를 나타내는 변수(is_followed)를 추가하여 JSON 형식으로 응답
- 팔로우 상태 여부를 JavaScript에게 전달할 데이터 작성
- 응답은 HTML 문서가 아닌 JSON 데이터로 응답하도록 변경(JsonResponse 활용)
```python
# accounts/views.py

from django.http import JsonResponse

@login_required
def follow(request, user_pk):
    User = get_user_model()
    person = User.objects.get(pk=user_pk)

    if person != request.user:
        if person.followers.filter(pk=request.user.pk).exists():
            person.followers.remove(request.user)
            is_followed = False
        else:
            person.followers.add(request.user)
            is_followed = True
        context = {
            'is_followed': is_followed,
        }
        return JsonResponse(context)
    return redirect('accounts:profile', person.username)
```
- 팔로우 요청 후 Django 서버로 부터 받은 응답 데이터 확인하기
```javascript
formTag.addEventListener('submit', function (event){
  event.preventDefault()
  const userId = event.currentTarget.dataset.userId

  axios({
    method: 'POST',  
    url: `/accounts/${userId}/follow/`, 
    headers: {'X-CSRFToken': csrftoken},
  })
    .then((response) => {
      console.log(response)
      console.log(response.data)
    })
})
```
- 응답 데이터 is_followed에 따라 팔로우 버튼을 조작하기
```javascript
axios({
  method: 'POST',  
  url: `/accounts/${userId}/follow/`, 
  headers: {'X-CSRFToken': csrftoken},
})
  .then((response) => {
    const isFollowed = response.data.is_followed
    const followBtn = document.querySelector('input[type=submit]')

    if (isFollowed === true) {
      followBtn.value = 'UnFollow'
    } else {
      followBtn.value = 'Follow'
    }
  })
```
- 클라이언트와 서버 간 XHR 객체를 주고 받는 것을 확인하기
- 개발자도구 - Network
- 팔로잉 수와 팔로워 수 비동기 적용
- Django view 함수에서 팔로워, 팔로잉 인원 수 연산을 진행하여 결과를 응답 데이터로 전달
```python
@login_required
def follow(request, user_pk):
    ...
        context = {
            'is_followed': is_followed,
            'followings_count': person.followings.count(),
            'followers_count': person.followers.count()
        }
        return JsonResponse(context)
    return redirect('accounts:profile', person.username)
```
- 해당 요소를 선택할 수 있도록 span 태그과 id 속성 작성
- 각 span 태그를 선택 후 응답 데이터를 받아 각 태그의 인원 수 값 변경에 활용
```html
<div>
  팔로워 : <span id='followers-count'>{{ person.followers.all|length }}</span> / 
  팔로우 : <span id='followings-count'>{{ person.followings.all|length }} </span>
</div>
```
```javascript
.then((response) => {
  ...
  const followingsCountTag = document.querySelector('#followings-count')
  const followersCountTag = document.querySelector('#followers-count')

  followingsCountTag.textContent = response.data.followings_count
  followersCountTag.textContent = response.data.followers_count
})
```
# Ajax with likes
## 비동기 좋아요 구현
### Ajax 좋아요 적용 시 유의사항
- 전반적인 Ajax 적용 방식은 팔로우 구현 과정과 동일
- 하지만 팔로우와 달리, 좋아요 버튼은 한 페이지에 여러개가 존재할 수 있음
- 그렇다면 모든 좋아요 버튼에 각각 이벤트 리스너를 등록해야 할까?
### 비동기 좋아요 구현 - Ajax 적용
- 모든 좋아요 form 요소를 포함하는 최상위 요소 작성
```html
<!-- articles/index.html -->

<article class="article-container">
  {% for article in articles %}
    ...
  {% endfor %}
</article>
```
1. 최상위 요소 선택
2. 이벤트 핸들러 할당
3. 하위 요소에서 발생하는 submit 이벤트를 감지하고, form의 기본 제출 동작을 취소
```javascript
const articleContainer = document.querySelector('.article-container')

articleContainer.addEventListener('submit', function (event) {
  event.preventDefault()
})
```
- axios 코드 작성
  - url 작성에 필요한 article pk는 어떻게 작성해야 할까?
```javascript
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value

articleContainer.addEventListener('submit', function (event) {
  event.preventDefault()

  axios({
    method: 'post',
    url: `/articles/${}/likes/`,
    headers: {'X-CSRFToken': csrftoken,},
  })
})
```
- 각 form에 data-article-id="{{ article.pk }}"와 같이 data-* 속성을 부여하여, JavaScript에서 참조할 수 있도록 하기
```html
<form data-article-id="{{ article.pk }}"> 
  ...
</form>
```
```javascript
// accounts/profile.html

articleContainer.addEventListener('submit', function (event) {
  event.preventDefault()
  const articleId = event.???
  ...
})
```
- url 완성 후 요청 밑 응답 확인
```javascript
articleContainer.addEventListener('submit', function (event) {
  event.preventDefault()

  const articleId = event.target.dataset.articleId

  axios({
    method: 'post',
    url: `/articles/${articleId}/likes/`,
    headers: {'X-CSRFToken': csrftoken,},
  })
    .then((response) => {
      console.log(response)
    })
    .catch((error) => {
      console.log(error)
    })
})
```
- 좋아요 버튼을 토글하기 위해서는 현재 사용자가 좋아요를 누른 상태인지 좋아요를 누르지 않은 상태인지에 대한 상태 확인이 필요
  - Django의 view 함수에서 좋아요 여부를 파악할 수 있는 변수 추가 생성
  - JSON 타입으로 응답하기
- 좋아요 상태 여부를 JavaScript에게 전달할 데이터 작성 밑 JSON 데이터 응답
```python
# articles/views.py

from django.http import JsonResponse

@login_required
def likes(request, article_pk):
    article = Article.objects.get(pk=article_pk)

    if request.user in article.like_users.all():
        article.like_users.remove(request.user)
        is_liked = False
    else:
        article.like_users.add(request.user)
        is_liked = True
    context = {
        'is_liked': is_liked,
    }
    return JsonResponse(context)
```
- 응답 데이터 is_liked를 받아 isLiked 변수에 할당
```javascript
axios({
  method: 'post',
  url: `/articles/${articleId}/likes/`,
  headers: {'X-CSRFToken': csrftoken,},
})
  .then((response) => {
    console.log(response)
    const isLiked = response.data.is_liked
  })
  .catch((error) => {
    console.log(error)
  })
```
- isLiked에 따라 좋아요 버튼을 토글하기
  - 어떤 게시글의 좋아요 버튼을 선택했는지 구별할 방법이 필요
```javascript
axios({
  method: 'post',
  url: `/articles/${articleId}/likes/`,
  headers: {'X-CSRFToken': csrftoken,},
})
  .then((response) => {
    console.log(response)
    const isLiked = response.data.is_liked
    const likeBtn = ??
  })
  .catch((error) => {
    console.log(error)
  })
```
- 문자열과 article.pk 값을 조합하여, 각 좋아요 버튼(또는 관련 요소)에 고유한 id 속성을 부여
- 각 좋아요 버튼을 선택 후 isLiked에 따라 버튼을 토글
```html
{% if request.user in article.like_users.all %}
  <input type="submit" value="좋아요 취소" id="like-{{article.pk}}">
{% else %}
  <input type="submit" value="좋아요" id="like-{{article.pk}}">
{% endif %}
```
```javascript
.then((response) => {
  const isLiked = response.data.is_liked
  const likeBtn = document.querySelector(`#like-${articleId}`)
  if (isLiked === true){
    likeBtn.value = "좋아요 취소"
  } else{
    likeBtn.value = "좋아요"
  }
})
```
### 비동기 좋아요 구현 - 버블링을 활용하지 않았다면?
1. querySelectorAll()을 사용해 전체 좋아요 버튼을 선택
   - querySelectorAll() 선택을 위한 class 적용
```html
<article class="article-container">
  {% for article in articles %}
    ...
    <form class="like-forms" data-article-id="{{ article.pk }}"> 
      {% csrf_token %}
      {% if request.user in article.like_users.all %}
        <input type="submit" value="좋아요 취소" id="like-{{article.pk}}">
      {% else %}
        <input type="submit" value="좋아요" id="like-{{article.pk}}">
      {% endif %}
    </form>
    <hr>
  {% endfor %}
</article>
```
2. forEach()를 사용해 전체 좋아요 버튼을 순회하면서 진행
```javascript
const formTags = document.querySelectorAll('.like-forms')
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value
console.log(articleContainer)

formTags.forEach((formTag) = > {
  formTag.addEventListener('submit', function (event) {
    event.preventDefault()
    const articleId = formTag.dataset.articleId

    axios({
      method: 'post',
      url: `/articles/${articleId}/likes/`,
      headers: {'X-CSRFToken': csrftoken,},
    })
      .then((response) => {
        const isLiked = response.data.is_liked
        const likeBtn = document.querySelector(`#like-${articleId}`)
        if(isLiked === true){
          likeBtn.value = "좋아요 취소"
        }else{
          likeBtn.value = "좋아요"
        }
      })
  })
})
```